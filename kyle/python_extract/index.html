



<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="Aggregated Medicare documentation in a single place">
      
      
        <link rel="canonical" href="https://kylebarron.github.io/medicare-documentation/kyle/python_extract/">
      
      
        <meta name="author" content="K">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-0.17.2, mkdocs-material-2.6.0">
    
    
      
        <title>Python Extraction - Medicare Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.aa3de92b.css">
      
        <link rel="stylesheet" href="../../assets/stylesheets/application-palette.792431c1.css">
      
    
    
      <script src="../../assets/javascripts/modernizr.1aa3b519.js"></script>
    
    
      
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Nunito+Sans:300,400,400i,700|Fira+Code">
        <style>body,input{font-family:"Nunito Sans","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Fira Code","Courier New",Courier,monospace}</style>
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="orange" data-md-color-accent="light-blue">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="search">
    <label class="md-overlay" data-md-component="overlay" for="drawer"></label>
    
      <a href="#python-extract" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://kylebarron.github.io/medicare-documentation/" title="Medicare Documentation" class="md-header-nav__button md-logo">
          
            <i class="md-icon">local_library</i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                Medicare Documentation
              </span>
              <span class="md-header-nav__topic">
                Python Extraction
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  


  <a href="https://github.com/kylebarron/medicare-documentation/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      medicare-documentation
    </div>
  </a>

          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
        

  

<nav class="md-tabs md-tabs--active" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  <li class="md-tabs__item">
    
      <a href="../.." title="Home" class="md-tabs__link">
        Home
      </a>
    
  </li>

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../NBER_website/1_Overview/" title="NBER Documentation" class="md-tabs__link">
          NBER Documentation
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../resdac/mbsf/" title="ResDAC Documentation" class="md-tabs__link">
          ResDAC Documentation
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../goals-for-modern-data-format/" title="Working with the Data" class="md-tabs__link md-tabs__link--active">
          Working with the Data
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../mauricio/enrollment-restrictions/" title="Important Details" class="md-tabs__link">
          Important Details
        </a>
      
    </li>
  

      
        
      
    </ul>
  </div>
</nav>
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="drawer">
    <span class="md-nav__button md-logo">
      
        <i class="md-icon">local_library</i>
      
    </span>
    Medicare Documentation
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/kylebarron/medicare-documentation/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      medicare-documentation
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      NBER Documentation
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        NBER Documentation
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../NBER_website/1_Overview/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../NBER_website/2_Background/" title="Description of Claims Files" class="md-nav__link">
      Description of Claims Files
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../NBER_website/3_Getting_started_with_SAS/" title="Getting Started with SAS" class="md-nav__link">
      Getting Started with SAS
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../NBER_website/4_constructing_extracts/" title="Constructing Extracts with SAS" class="md-nav__link">
      Constructing Extracts with SAS
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../NBER_website/5_manipulating_medicare_extracts/" title="Manipulating Extracts with SAS" class="md-nav__link">
      Manipulating Extracts with SAS
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../NBER_website/6_costs/" title="Generating Costs Measures" class="md-nav__link">
      Generating Costs Measures
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../NBER_website/7_references/" title="References" class="md-nav__link">
      References
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../NBER_website/8_appendix/" title="Appendix" class="md-nav__link">
      Appendix
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-9" type="checkbox" id="nav-2-9">
    
    <label class="md-nav__link" for="nav-2-9">
      Variable Names Crosswalk
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-9">
        Variable Names Crosswalk
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../NBER_website/opxw/" title="Outpatient" class="md-nav__link">
      Outpatient
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      ResDAC Documentation
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        ResDAC Documentation
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../resdac/mbsf/" title="Beneficiary Summary File" class="md-nav__link">
      Beneficiary Summary File
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../resdac/carrier-rif/" title="Carrier RIF" class="md-nav__link">
      Carrier RIF
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../resdac/denominator-rif/" title="Denominator RIF" class="md-nav__link">
      Denominator RIF
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../resdac/dme-rif/" title="Durable Medical Equipment RIF" class="md-nav__link">
      Durable Medical Equipment RIF
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../resdac/hha-rif/" title="Home Health Agency RIF" class="md-nav__link">
      Home Health Agency RIF
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../resdac/hospice-rif/" title="Hospice RIF" class="md-nav__link">
      Hospice RIF
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../resdac/ip-rif/" title="Inpatient RIF" class="md-nav__link">
      Inpatient RIF
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../resdac/medpar-rif/" title="MedPAR RIF" class="md-nav__link">
      MedPAR RIF
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../resdac/op-rif/" title="Outpatient RIF" class="md-nav__link">
      Outpatient RIF
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../resdac/snf-rif/" title="Skilled Nursing Facility RIF" class="md-nav__link">
      Skilled Nursing Facility RIF
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../resdac/variables/" title="Variable Definitions" class="md-nav__link">
      Variable Definitions
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4" checked>
    
    <label class="md-nav__link" for="nav-4">
      Working with the Data
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Working with the Data
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../goals-for-modern-data-format/" title="Goals for New Data Format" class="md-nav__link">
      Goals for New Data Format
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../01medicare_readme/" title="Standard Readme" class="md-nav__link">
      Standard Readme
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../extract_data/" title="Data Extraction Overview" class="md-nav__link">
      Data Extraction Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../data_locations/" title="Data Locations" class="md-nav__link">
      Data Locations
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="toc">
        Python Extraction
      </label>
    
    <a href="./" title="Python Extraction" class="md-nav__link md-nav__link--active">
      Python Extraction
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#start" title="Start" class="md-nav__link">
    Start
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#importing-packages" title="Importing packages" class="md-nav__link">
    Importing packages
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#make-file-paths" title="Make file paths" class="md-nav__link">
    Make file paths
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#import-demographic-data" title="Import Demographic Data" class="md-nav__link">
    Import Demographic Data
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#outpatient-encounters" title="Outpatient Encounters" class="md-nav__link">
    Outpatient Encounters
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#define-columns-to-keep" title="Define columns to keep" class="md-nav__link">
    Define columns to keep
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#loop-over-rows-in-outpatient-files" title="Loop over rows in outpatient files" class="md-nav__link">
    Loop over rows in outpatient files
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#export-to-stata-file" title="Export to Stata file" class="md-nav__link">
    Export to Stata file
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#entire-script" title="Entire script" class="md-nav__link">
    Entire script
  </a>
  
</li>
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../using-tmux-aging-servers/" title="Using tmux for long-running jobs" class="md-nav__link">
      Using tmux for long-running jobs
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      Important Details
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        Important Details
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../mauricio/enrollment-restrictions/" title="Enrollment Restrictions" class="md-nav__link">
      Enrollment Restrictions
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../mauricio/lag-post-event-spending/" title="Calculating Costs for Inpatient Visits" class="md-nav__link">
      Calculating Costs for Inpatient Visits
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../glossary/" title="Glossary" class="md-nav__link">
      Glossary
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#start" title="Start" class="md-nav__link">
    Start
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#importing-packages" title="Importing packages" class="md-nav__link">
    Importing packages
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#make-file-paths" title="Make file paths" class="md-nav__link">
    Make file paths
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#import-demographic-data" title="Import Demographic Data" class="md-nav__link">
    Import Demographic Data
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#outpatient-encounters" title="Outpatient Encounters" class="md-nav__link">
    Outpatient Encounters
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#define-columns-to-keep" title="Define columns to keep" class="md-nav__link">
    Define columns to keep
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#loop-over-rows-in-outpatient-files" title="Loop over rows in outpatient files" class="md-nav__link">
    Loop over rows in outpatient files
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#export-to-stata-file" title="Export to Stata file" class="md-nav__link">
    Export to Stata file
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#entire-script" title="Entire script" class="md-nav__link">
    Entire script
  </a>
  
</li>
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/kylebarron/medicare-documentation/blob/master/docs/kyle/python_extract.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="python-extract">Python Extract<a class="headerlink" href="#python-extract" title="Permanent link">&para;</a></h1>
<p>This document details my Python script to extract Medicare data. I'll go through it one important segment at a time; the entire script is at the bottom.</p>
<h2 id="start">Start<a class="headerlink" href="#start" title="Permanent link">&para;</a></h2>
<p>First is a header with helpful metadata. The <code>#! /usr/bin/env python3</code> is just a standard way to reference python files that allows for the convenience of running them from the command line with <code>./filename.py</code>.</p>
<div class="codehilite"><pre><span></span><span class="ch">#! /usr/bin/env python3</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">---------------------------------------------------------------------</span>
<span class="sd">Project: cms-age-discont</span>
<span class="sd">Program: 01mammogram_select.py</span>
<span class="sd">Author:  Kyle Barron &lt;barronk@mit.edu&gt;</span>
<span class="sd">Created: 12/12/2017, 5:15:29 PM</span>
<span class="sd">Updated: 12/12/2017, 5:15:29 PM</span>
<span class="sd">Purpose: Select data for age discontinuity analysis in a scalable way</span>
<span class="sd">Depends: data/raw_harm/PCTpct/op/</span>
<span class="sd">    opPCT_clms_raw_YEAR.dta</span>
<span class="sd">Output:  data/base/</span>
<span class="sd">    appts_30d_dob_mamm_2011.dta</span>
<span class="sd">&quot;&quot;&quot;</span>
</pre></div>


<h2 id="importing-packages">Importing packages<a class="headerlink" href="#importing-packages" title="Permanent link">&para;</a></h2>
<p>In Python, new functionality comes in the form of <strong>packages</strong>, which are bundles of code that allow you to do complicated things with few lines of code. I import five packages beyond the base language:</p>
<ol>
<li>Add regular expression support for strings with the <code>re</code> package</li>
<li>Add support for working with rectangular dataframes with the <code>pandas</code> package. The code <code>import pandas as pd</code> means that I can reference the package with <code>pd</code> instead of writing <code>pandas</code> everywhere in my code.</li>
<li>Add <code>time</code> to allow me to time how long things take.</li>
<li>I import just the <code>path</code> command from the <code>os</code> package, which makes it easier to specify file paths.</li>
<li>I import the <code>relativedelta</code> command from the <code>dateutil</code> package, which makes it easy to deal with spans of time, like finding dates that are a month after a birthday.</li>
</ol>
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">path</span>
<span class="kn">from</span> <span class="nn">dateutil.relativedelta</span> <span class="kn">import</span> <span class="n">relativedelta</span>
</pre></div>


<h2 id="make-file-paths">Make file paths<a class="headerlink" href="#make-file-paths" title="Permanent link">&para;</a></h2>
<p>I create variables for <code>datadir</code>, <code>pct</code>, and <code>year</code>, because these values will change in the future. After, I create an object with the file paths for the demographic and outpatient data files. These are just like locals in Stata. The <code>path.join</code> function adds in a <code>/</code> (on Linux) whenever there's a <code>,</code>. So <code>op_path</code> holds the value <code>data/raw_harm/0001pct/op/op0001_clms_raw_2011.dta</code>.</p>
<div class="codehilite"><pre><span></span><span class="n">datadir</span> <span class="o">=</span> <span class="s1">&#39;data&#39;</span>
<span class="n">pct</span> <span class="o">=</span> <span class="s1">&#39;0001&#39;</span>
<span class="n">year</span> <span class="o">=</span> <span class="s1">&#39;2011&#39;</span>

<span class="c1"># File paths:</span>
<span class="n">idcharvar_path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
    <span class="n">datadir</span><span class="p">,</span>
    <span class="s1">&#39;raw_harm&#39;</span><span class="p">,</span>
    <span class="n">pct</span> <span class="o">+</span> <span class="s1">&#39;pct&#39;</span><span class="p">,</span>
    <span class="s1">&#39;denom_bene&#39;</span><span class="p">,</span>
    <span class="s1">&#39;pop&#39;</span> <span class="o">+</span> <span class="n">pct</span> <span class="o">+</span> <span class="s1">&#39;_demo_bene_idcharvar&#39;</span> <span class="o">+</span> <span class="n">year</span> <span class="o">+</span> <span class="s1">&#39;.dta&#39;</span>
<span class="p">)</span>
<span class="n">op_path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
    <span class="n">datadir</span><span class="p">,</span>
    <span class="s1">&#39;raw_harm&#39;</span><span class="p">,</span>
    <span class="n">pct</span> <span class="o">+</span> <span class="s1">&#39;pct&#39;</span><span class="p">,</span>
    <span class="s1">&#39;op&#39;</span><span class="p">,</span>
    <span class="s1">&#39;op&#39;</span> <span class="o">+</span> <span class="n">pct</span> <span class="o">+</span> <span class="s1">&#39;_clms_raw_&#39;</span> <span class="o">+</span> <span class="n">year</span> <span class="o">+</span> <span class="s1">&#39;.dta&#39;</span>
<span class="p">)</span>
</pre></div>


<h2 id="import-demographic-data">Import Demographic Data<a class="headerlink" href="#import-demographic-data" title="Permanent link">&para;</a></h2>
<p>Next I want to import demographic data, so that I can match birth dates to <code>bene_id</code>s.</p>
<ul>
<li>The first line of code reads the entire Stata file at the path listed in <code>idcharvar_path</code>. It's basically the same as Stata's <code>use sdod sdob sex bene_id using `idcharvar_path'</code>. This is put into the object named <code>demo_bene</code>.</li>
<li>The next line drops the rows for which <code>sex</code> is equal to <code>1</code>. In Python you <em>index</em> with <code>[]</code>. So <code>demo_bene['sex']</code> gives you just the single column of the data set <code>sex</code>. <code>demo_bene[demo_bene['sex'] == '1']</code> gives you the rows of the dataset for which <code>sex</code> is equal to 1. The command drops those rows.</li>
<li>To minimize the dataset size before joining other data, I also drop rows for which the date of death is before the first day of the current year. So since <code>year</code> is currently set to <code>2011</code>, this drops all people who died before January 1, 2011.</li>
<li>Lastly, I drop the columns <code>sex</code> and <code>sdod</code>.</li>
</ul>
<div class="codehilite"><pre><span></span><span class="c1"># First get list of all bene_id date of birth combos for women</span>
<span class="c1"># Import demographic data</span>
<span class="c1"># Doesn&#39;t need to be iterated; the 100% datasets are only ~2.5GB in size</span>
<span class="n">demo_bene</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_stata</span><span class="p">(</span>
    <span class="n">idcharvar_path</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sdod&#39;</span><span class="p">,</span> <span class="s1">&#39;sdob&#39;</span><span class="p">,</span> <span class="s1">&#39;sex&#39;</span><span class="p">,</span> <span class="s1">&#39;bene_id&#39;</span><span class="p">]</span>
<span class="p">)</span>

<span class="c1"># Drop males</span>
<span class="n">demo_bene</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">demo_bene</span><span class="p">[</span><span class="n">demo_bene</span><span class="p">[</span><span class="s1">&#39;sex&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>

<span class="c1"># Drop if sdod is before year</span>
<span class="n">demo_bene</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
    <span class="n">demo_bene</span><span class="p">[</span><span class="n">demo_bene</span><span class="p">[</span><span class="s1">&#39;sdod&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">year</span> <span class="o">+</span> <span class="s1">&#39;-01-01&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
    <span class="n">inplace</span> <span class="o">=</span> <span class="bp">True</span>
<span class="p">)</span>
<span class="n">demo_bene</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;sex&#39;</span><span class="p">,</span> <span class="s1">&#39;sdod&#39;</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
</pre></div>


<h2 id="outpatient-encounters">Outpatient Encounters<a class="headerlink" href="#outpatient-encounters" title="Permanent link">&para;</a></h2>
<h3 id="define-columns-to-keep">Define columns to keep<a class="headerlink" href="#define-columns-to-keep" title="Permanent link">&para;</a></h3>
<p>The following generates the list of columns I want to keep from the outpatient claims file.</p>
<ul>
<li>The first line puts the list of all column names in the stata file into the object named <code>columns</code>.</li>
<li>The second creates a list with three strings of variables that I want to keep.</li>
<li>I want to keep all columns <code>icd_dgns_cd*</code> so that I can see if any of the diagnosis codes correspond to a mammogram. But Python doesn't recognize the use of the <code>*</code> there, so it returns an error. Instead, I loop over all the columns in <code>columns</code>. If the column name matches the regular expression string <code>icd_dgns_cd\d+</code>, which means the text <code>icd_dgns_cd</code> plus one or more digits, then it adds the variable name to the list <code>tokeep</code>.</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For loops and if statements in Python rely on indentation to determine when the clause finishes. If a statement is meant to run after a loop, it must be placed at the same indentation level as the initial for loop statement.</p>
</div>
<div class="codehilite"><pre><span></span><span class="c1"># Find all op encounters within 30 days of their birthday (ages 66-80)</span>
<span class="c1">## First, import outpatient data</span>
<span class="c1"># Create list of columns to retrieve from stata file</span>
<span class="n">columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">read_stata</span><span class="p">(</span><span class="n">op_path</span><span class="p">,</span> <span class="n">iterator</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">variable_labels</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="n">tokeep</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;bene_id&#39;</span><span class="p">,</span> <span class="s1">&#39;clm_id&#39;</span><span class="p">,</span> <span class="s1">&#39;from_dt&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;icd_dgns_cd\d+&#39;</span><span class="p">,</span> <span class="n">column</span><span class="p">):</span>
        <span class="n">tokeep</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>
</pre></div>


<h3 id="loop-over-rows-in-outpatient-files">Loop over rows in outpatient files<a class="headerlink" href="#loop-over-rows-in-outpatient-files" title="Permanent link">&para;</a></h3>
<p>This is the main part of the code.</p>
<ul>
<li><code>df_extracted = []</code> creates an empty list. This list will hold all the clean data from each iteration of the for loop.</li>
<li><code>itr = pd.read_stata(op_path, columns = tokeep, chunksize = 10000)</code> creates an object that I can loop over. For each iteration of this loop, Python will read the Stata file at path <code>op_path</code>, the columns defined by <code>tokeep</code>, and 10,000 rows at a time. This is equivalent to <code>use `tokeep' using `op_path' in 1/10000</code> in Stata (with a bit more finesse needed for accurately looping over the entire dataset 10,000 rows at a time).</li>
<li><code>for df in itr:</code> starts the for loop. <code>itr</code> is the name of the object I'm looping over, created in the previous statement. Since I use the name <code>df</code> in the for loop, the rest of the loop will be coded in terms of <code>df</code>. Each use of <code>df</code> refers to one chunk of 10,000 rows of the Stata file.</li>
<li><code>df = df.merge(demo_bene, on = 'bene_id')</code> merges the <code>demo_bene</code> dataset created earlier to the outpatient file. This is a <strong>left join</strong>, akin to <code>merge n:1 bene_id using demo_bene, keep(master)</code>. So I'm only left with the observations in <code>df</code> that have a match in <code>demo_bene</code>. I'll add an assert statement later to make sure that the number of observations in <code>df</code> before and after the merge is equal.</li>
<li><code>df['diff'] = df.apply(lambda row: relativedelta(row['from_dt'], row['sdob']), axis = 1)</code> adds a new variable to <code>df</code> named <code>diff</code>. <code>df.apply(function, axis = 1)</code> means to apply a function to every row of the dataset. The function here is <code>lambda row: relativedelta(row['from_dt'], row['sdob'])</code>, which just means, for each row of the dataset, use the values of <code>from_dt</code> and <code>sdob</code> in the function <code>relativedelta</code>. This outputs a special type of object that is the difference in time between the two dates. In Stata, subtracting two dates gives you a constant: the number of days between them. But this special type in Python understands the calendar better. Doing something like <code>relativedelta('2011-05-25', '2005-01-13')</code> will give output that understands that was 6 years, 4 months, and 12 days, and means you don't have to rely on there being 365.25 days in a year.</li>
<li>The next part keeps only the rows that meet specified criteria. This restricts the entire dataset <code>df</code> to those for whom the value of the <code>diff</code> column is at least 66 years and less than 80 years, and for whom the number of months is equal to zero. This means I'm restricting currently to those people whose encounter is no more than <em>a month</em> after their birthday, instead of <em>30 days</em> after. I can change this if you want.</li>
</ul>
<div class="codehilite"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;diff&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">years</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">66</span><span class="p">)</span> <span class="o">&amp;</span>
        <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;diff&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">years</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">80</span><span class="p">)</span> <span class="o">&amp;</span>
        <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;diff&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">months</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)]</span>
</pre></div>


<ul>
<li>Next I create an indicator variable for if the encounter contained a mammogram diagnosis. I create a variable <code>has_mammogram</code> that's <code>False</code> by default. I loop over all columns in the dataset that start with <code>icd_dgns_cd</code>. If a the value of <code>icd_dgns_cd*</code> in a row is either <code>V7612</code>, <code>V7611</code>, or <code>79380</code>, it makes the value of <code>has_mammogram</code> <code>True</code> for that row. It then drops each column as it goes, since those columns are no longer needed.</li>
<li>We now have a clean dataset in <code>df</code>. But since this is in a for loop, we have to save <code>df</code> somehow, otherwise it'll be overwritten in the next iteration of the loop. <code>df_extracted.append(df)</code> adds <code>df</code> to the empty list <code>df_extracted</code> we created at the beginning of this section.</li>
<li>Once the for loop finishes, each element of the list <code>df_extracted</code> is a rectangular data frame. The command <code>df_extracted = pd.concat(df_extracted, axis = 0)</code> <em>flattens</em> the list. It turns the list of data frames into a single data frame, concatenating each element.</li>
</ul>
<div class="codehilite"><pre><span></span><span class="n">df_extracted</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">itr</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_stata</span><span class="p">(</span><span class="n">op_path</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">tokeep</span><span class="p">,</span> <span class="n">chunksize</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">)</span>
<span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">itr</span><span class="p">:</span>
    <span class="c1"># I now have outpatient data; merge birthdays on `bene_id`</span>
    <span class="c1"># This does a *left join* by default,</span>
    <span class="c1">#  so it keeps everything from `df` and only keeps the matched obs</span>
    <span class="c1">#  from `bene_id`</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">demo_bene</span><span class="p">,</span> <span class="n">on</span> <span class="o">=</span> <span class="s1">&#39;bene_id&#39;</span><span class="p">)</span>

    <span class="c1"># Keep if the appointment is within 30 days after their birthday.</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;diff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">relativedelta</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;from_dt&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;sdob&#39;</span><span class="p">]),</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="p">)</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;diff&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">years</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">66</span><span class="p">)</span> <span class="o">&amp;</span>
            <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;diff&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">years</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">80</span><span class="p">)</span> <span class="o">&amp;</span>
            <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;diff&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">months</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)]</span>

    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;has_mammogram&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;icd_dgns_cd&#39;</span><span class="p">)]</span>
    <span class="c1"># This tests all columns in cols,</span>
    <span class="c1">#  and if text matches the regex, makes &#39;has_mammogram&#39; = True</span>
    <span class="c1">## Mammogram values:</span>
    <span class="c1">## V76.12 &#39;Other Screening mammogram&#39;</span>
    <span class="c1">## 793.80 &#39;Abnormal mammogram, unspecified&#39;</span>
    <span class="c1">## V76.11 &#39;Screening mammogram for high-risk patient&#39;</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;V761(?:2|1)|79380&#39;</span><span class="p">),</span> <span class="s1">&#39;has_mammogram&#39;</span>
              <span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>

    <span class="n">df_extracted</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="c1"># break</span>

<span class="n">df_extracted</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">df_extracted</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>


<h2 id="export-to-stata-file">Export to Stata file<a class="headerlink" href="#export-to-stata-file" title="Permanent link">&para;</a></h2>
<p>We now have the data frame <code>df_extracted</code> with the data we want from the entire outpatient data. We just need to export this data back to Stata format.</p>
<ul>
<li>First, I drop the <code>diff</code> column, because it holds the special type corresponding to the difference in datetimes, and this type isn't supported in Stata.</li>
<li>Then I change the <code>has_mammogram</code> column from having values <code>True</code>/<code>False</code> to having values <code>1</code>/<code>0</code>.</li>
<li>Next is the actual export the the Stata file. I export to the file path <code>data/base/appts_30d_dob_mamm_2011.dta</code>, I ask it to convert the two date columns to Stata's <code>td</code> format, and I ask it to not add the <em>index</em> column. The index column is an extra column in the Pandas package that just refers to <code>_n</code> in Stata.</li>
<li>Last I record the end time of the program and show that value. The 1% sample in 2011 took about 500 seconds.</li>
</ul>
<div class="codehilite"><pre><span></span><span class="n">df_extracted</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;diff&#39;</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
<span class="n">df_extracted</span><span class="o">.</span><span class="n">has_mammogram</span> <span class="o">=</span> <span class="n">df_extracted</span><span class="o">.</span><span class="n">has_mammogram</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="n">df_extracted</span><span class="o">.</span><span class="n">to_stata</span><span class="p">(</span>
    <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span> <span class="s1">&#39;base&#39;</span><span class="p">,</span> <span class="s1">&#39;appts_30d_dob_mamm_2011.dta&#39;</span><span class="p">),</span>
    <span class="n">convert_dates</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;from_dt&#39;</span><span class="p">:</span> <span class="s1">&#39;td&#39;</span><span class="p">,</span>
        <span class="s1">&#39;sdob&#39;</span><span class="p">:</span> <span class="s1">&#39;td&#39;</span>
    <span class="p">},</span>
    <span class="n">write_index</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span>

<span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">t1</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span>
</pre></div>


<h2 id="entire-script">Entire script<a class="headerlink" href="#entire-script" title="Permanent link">&para;</a></h2>
<div class="codehilite"><pre><span></span><span class="ch">#! /usr/bin/env python3</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">---------------------------------------------------------------------</span>
<span class="sd">Project: cms-age-discont</span>
<span class="sd">Program: 01mammogram_select.py</span>
<span class="sd">Author:  Kyle Barron &lt;barronk@mit.edu&gt;</span>
<span class="sd">Created: 12/12/2017, 5:15:29 PM</span>
<span class="sd">Updated: 12/12/2017, 5:15:29 PM</span>
<span class="sd">Purpose: Select data for age discontinuity analysis in a scalable way</span>
<span class="sd">Depends: data/raw_harm/PCTpct/op/</span>
<span class="sd">    opPCT_clms_raw_YEAR.dta</span>
<span class="sd">Output:  data/base/</span>
<span class="sd">    appts_30d_dob_mamm_2011.dta</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">path</span>
<span class="kn">from</span> <span class="nn">dateutil.relativedelta</span> <span class="kn">import</span> <span class="n">relativedelta</span>

<span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="n">datadir</span> <span class="o">=</span> <span class="s1">&#39;data&#39;</span>
<span class="n">pct</span> <span class="o">=</span> <span class="s1">&#39;0001&#39;</span>
<span class="n">year</span> <span class="o">=</span> <span class="s1">&#39;2011&#39;</span>

<span class="c1"># File paths:</span>
<span class="n">idcharvar_path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
    <span class="n">datadir</span><span class="p">,</span> <span class="s1">&#39;raw_harm&#39;</span><span class="p">,</span> <span class="n">pct</span> <span class="o">+</span> <span class="s1">&#39;pct&#39;</span><span class="p">,</span> <span class="s1">&#39;denom_bene&#39;</span><span class="p">,</span>
    <span class="s1">&#39;pop&#39;</span> <span class="o">+</span> <span class="n">pct</span> <span class="o">+</span> <span class="s1">&#39;_demo_bene_idcharvar&#39;</span> <span class="o">+</span> <span class="n">year</span> <span class="o">+</span> <span class="s1">&#39;.dta&#39;</span>
<span class="p">)</span>
<span class="n">op_path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
    <span class="n">datadir</span><span class="p">,</span> <span class="s1">&#39;raw_harm&#39;</span><span class="p">,</span> <span class="n">pct</span> <span class="o">+</span> <span class="s1">&#39;pct&#39;</span><span class="p">,</span> <span class="s1">&#39;op&#39;</span><span class="p">,</span>
    <span class="s1">&#39;op&#39;</span> <span class="o">+</span> <span class="n">pct</span> <span class="o">+</span> <span class="s1">&#39;_clms_raw_&#39;</span> <span class="o">+</span> <span class="n">year</span> <span class="o">+</span> <span class="s1">&#39;.dta&#39;</span>
<span class="p">)</span>

<span class="c1"># 1) Unbalanced panel:</span>
<span class="c1"># I want anybody who had op visit within 30 days of when they turn 66 - 80</span>
<span class="c1"># What fraction of those had mammograms?</span>

<span class="c1"># First get list of all bene_id date of birth combos for women</span>
<span class="c1"># Import demographic data</span>
<span class="c1"># Doesn&#39;t need to be iterated; the 100% datasets are only ~2.5GB in size</span>
<span class="n">demo_bene</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_stata</span><span class="p">(</span>
    <span class="n">idcharvar_path</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sdod&#39;</span><span class="p">,</span> <span class="s1">&#39;sdob&#39;</span><span class="p">,</span> <span class="s1">&#39;sex&#39;</span><span class="p">,</span> <span class="s1">&#39;bene_id&#39;</span><span class="p">]</span>
<span class="p">)</span>

<span class="c1"># Drop males</span>
<span class="n">demo_bene</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">demo_bene</span><span class="p">[</span><span class="n">demo_bene</span><span class="p">[</span><span class="s1">&#39;sex&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>

<span class="c1"># Drop if sdod is before year</span>
<span class="n">demo_bene</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
    <span class="n">demo_bene</span><span class="p">[</span><span class="n">demo_bene</span><span class="p">[</span><span class="s1">&#39;sdod&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">year</span> <span class="o">+</span> <span class="s1">&#39;-01-01&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
    <span class="n">inplace</span> <span class="o">=</span> <span class="bp">True</span>
<span class="p">)</span>
<span class="n">demo_bene</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;sex&#39;</span><span class="p">,</span> <span class="s1">&#39;sdod&#39;</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>

<span class="c1"># Find all op encounters within 30 days of their birthday (ages 66-80)</span>
<span class="c1">## First, import outpatient data</span>
<span class="c1"># Create list of columns to retrieve from stata file</span>
<span class="n">columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">read_stata</span><span class="p">(</span><span class="n">op_path</span><span class="p">,</span> <span class="n">iterator</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">variable_labels</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="n">tokeep</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;bene_id&#39;</span><span class="p">,</span> <span class="s1">&#39;clm_id&#39;</span><span class="p">,</span> <span class="s1">&#39;from_dt&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;icd_dgns_cd\d+&#39;</span><span class="p">,</span> <span class="n">column</span><span class="p">):</span>
        <span class="n">tokeep</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>

<span class="n">df_extracted</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">itr</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_stata</span><span class="p">(</span><span class="n">op_path</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">tokeep</span><span class="p">,</span> <span class="n">chunksize</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">)</span>
<span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">itr</span><span class="p">:</span>
    <span class="c1"># I now have outpatient data; merge birthdays on `bene_id`</span>
    <span class="c1"># This does a *left join* by default,</span>
    <span class="c1">#  so it keeps everything from `df` and only keeps the matched obs</span>
    <span class="c1">#  from `bene_id`</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">demo_bene</span><span class="p">,</span> <span class="n">on</span> <span class="o">=</span> <span class="s1">&#39;bene_id&#39;</span><span class="p">)</span>

    <span class="c1"># Keep if the appointment is within 30 days after their birthday.</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;diff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">relativedelta</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;from_dt&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;sdob&#39;</span><span class="p">]),</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="p">)</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;diff&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">years</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">66</span><span class="p">)</span> <span class="o">&amp;</span>
            <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;diff&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">years</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">80</span><span class="p">)</span> <span class="o">&amp;</span>
            <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;diff&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">months</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)]</span>

    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;has_mammogram&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;icd_dgns_cd&#39;</span><span class="p">)]</span>
    <span class="c1"># This tests all columns in cols,</span>
    <span class="c1">#  and if text matches the regex, makes &#39;has_mammogram&#39; = True</span>
    <span class="c1">## Mammogram values:</span>
    <span class="c1">## V76.12 &#39;Other Screening mammogram&#39;</span>
    <span class="c1">## 793.80 &#39;Abnormal mammogram, unspecified&#39;</span>
    <span class="c1">## V76.11 &#39;Screening mammogram for high-risk patient&#39;</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;V761(?:2|1)|79380&#39;</span><span class="p">),</span> <span class="s1">&#39;has_mammogram&#39;</span>
              <span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>

    <span class="n">df_extracted</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="c1"># break</span>

<span class="n">df_extracted</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">df_extracted</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
<span class="c1"># With the 2011 1% sample, this took 500 seconds</span>

<span class="n">df_extracted</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;diff&#39;</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
<span class="n">df_extracted</span><span class="o">.</span><span class="n">has_mammogram</span> <span class="o">=</span> <span class="n">df_extracted</span><span class="o">.</span><span class="n">has_mammogram</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="n">df_extracted</span><span class="o">.</span><span class="n">to_stata</span><span class="p">(</span>
    <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datadir</span><span class="p">,</span> <span class="s1">&#39;base&#39;</span><span class="p">,</span> <span class="s1">&#39;appts_30d_dob_mamm_2011.dta&#39;</span><span class="p">),</span>
    <span class="n">convert_dates</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;from_dt&#39;</span><span class="p">:</span> <span class="s1">&#39;td&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;sdob&#39;</span><span class="p">:</span> <span class="s1">&#39;td&#39;</span><span class="p">},</span>
    <span class="n">write_index</span> <span class="o">=</span> <span class="bp">False</span>
<span class="p">)</span>

<span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">t1</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span>
<span class="c1"># 525.5</span>
</pre></div>
                
                  
                
              
              
                
              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../data_locations/" title="Data Locations" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Data Locations
              </span>
            </div>
          </a>
        
        
          <a href="../using-tmux-aging-servers/" title="Using tmux for long-running jobs" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Using tmux for long-running jobs
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="http://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.9fb73e57.js"></script>
      
      <script>app.initialize({version:"0.17.2",url:{base:"../.."}})</script>
      
        <script src="../../js/helpers.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      
    
    
      
    
  </body>
</html>